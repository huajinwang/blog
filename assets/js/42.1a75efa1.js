(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{537:function(s,n,e){"use strict";e.r(n);var a=e(6),t=Object(a.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("每当被问到Vue数据双向绑定原理的时候，大家可能都会脱口而出：Vue内部通过"),e("code",[s._v("Object.defineProperty")]),s._v("方法属性拦截的方式，"),s._v("把"),e("code",[s._v("data")]),s._v("对象里每个数据的读写转化成"),e("code",[s._v("getter")]),s._v("/"),e("code",[s._v("setter")]),s._v("，当数据变化时通知视图更新。虽然一句话把大概原理概括了，但是其内部的实现方式还是值得深究的，本文就以通俗易懂的方式剖析Vue内部双向绑定原理的实现过程。")]),s._v(" "),e("h2",{attrs:{id:"思路分析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#思路分析"}},[s._v("#")]),s._v(" 思路分析")]),s._v(" "),e("p",[s._v("所谓MVVM数据双向绑定，即主要是：数据变化更新视图，视图变化更新数据。如下图：\n"),e("img",{attrs:{src:"https://img2018.cnblogs.com/blog/1460995/201810/1460995-20181031161854521-1079176767.jpg",alt:"img"}})]),s._v(" "),e("p",[s._v("也就是说：")]),s._v(" "),e("ul",[e("li",[s._v("输入框内容变化时，data 中的数据同步变化。即 view => model 的变化。")]),s._v(" "),e("li",[s._v("data 中的数据变化时，文本节点的内容同步变化。即 model => view 的变化。")])]),s._v(" "),e("p",[s._v("要实现这两个过程，关键点在于数据变化如何更新视图，因为视图变化更新数据我们可以通过事件监听的方式来实现。所以我们着重讨论数据变化如何更新视图。")]),s._v(" "),e("p",[s._v("数据变化更新视图的关键点则在于我们如何知道数据发生了变化，只要知道数据在什么时候变了，那么问题就变得迎刃而解，我们只需在数据变化的时候去通知视图更新即可。")]),s._v(" "),e("h2",{attrs:{id:"使数据对象变得-可观测"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使数据对象变得-可观测"}},[s._v("#")]),s._v(" 使数据对象变得“可观测”")]),s._v(" "),e("p",[s._v("数据的每次读和写能够被我们看的见，即我们能够知道数据什么时候被读取了或数据什么时候被改写了，我们将其称为数据变的‘可观测’。")]),s._v(" "),e("p",[s._v("要将数据变的‘可观测’，我们就要借助前言中提到的"),e("code",[s._v("Object.defineProperty")]),s._v("方法了，关于该方法，MDN上是这么介绍的：")]),s._v(" "),e("blockquote",[e("p",[s._v("Object.defineProperty() 方法会直接在一个对象上定义一个新属性，或者修改一个对象的现有属性， 并返回这个对象。")])]),s._v(" "),e("p",[s._v("在本文中，我们就使用这个方法使数据变得“可观测”。")]),s._v(" "),e("p",[s._v("首先，我们定义一个数据对象"),e("code",[s._v("car")]),s._v("：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("let car = {\n        'brand':'BMW',\n        'price':3000\n    }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("我们定义了这个"),e("code",[s._v("car")]),s._v("的品牌"),e("code",[s._v("brand")]),s._v("是"),e("code",[s._v("BMW")]),s._v(",价格"),e("code",[s._v("price")]),s._v("是3000。现在我们可以通过"),e("code",[s._v("car.brand")]),s._v("和"),e("code",[s._v("car.price")]),s._v("直接读写这个"),e("code",[s._v("car")]),s._v("对应的属性值。但是，当这个"),e("code",[s._v("car")]),s._v("的属性被读取或修改时，我们并不知情。那么应该如何做才能够让"),e("code",[s._v("car")]),s._v("主动告诉我们，它的属性被修改了呢？")]),s._v(" "),e("p",[s._v("接下来，我们使用"),e("code",[s._v("Object.defineProperty()")]),s._v("改写上面的例子：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    let car = {}\n    let val = 3000\n    Object.defineProperty(car, 'price', {\n        get(){\n            console.log('price属性被读取了')\n            return val\n        },\n        set(newVal){\n            console.log('price属性被修改了')\n            val = newVal\n        }\n    })\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("p",[s._v("通过"),e("code",[s._v("Object.defineProperty()")]),s._v("方法给"),e("code",[s._v("car")]),s._v("定义了一个"),e("code",[s._v("price")]),s._v("属性，并把这个属性的读和写分别使用"),e("code",[s._v("get()")]),s._v("和"),e("code",[s._v("set()")]),s._v("进行拦截，每当该属性进行读或写操作的时候就会出发"),e("code",[s._v("get()")]),s._v("和"),e("code",[s._v("set()")]),s._v("。如下图：\n"),e("img",{attrs:{src:"https://img2018.cnblogs.com/blog/1460995/201810/1460995-20181031161911510-1865322905.png",alt:"img"}})]),s._v(" "),e("p",[s._v("可以看到，"),e("code",[s._v("car")]),s._v("已经可以主动告诉我们它的属性的读写情况了，这也意味着，这个"),e("code",[s._v("car")]),s._v("的数据对象已经是“可观测”的了。")]),s._v(" "),e("p",[s._v("为了把"),e("code",[s._v("car")]),s._v("的所有属性都变得可观测，我们可以编写如下两个函数：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("/**\n     * 把一个对象的每一项都转化成可观测对象\n     * @param { Object } obj 对象\n     */\n    function observable (obj) {\n        if (!obj || typeof obj !== 'object') {\n            return;\n        }\n        let keys = Object.keys(obj);\n        keys.forEach((key) =>{\n            defineReactive(obj,key,obj[key])\n        })\n        return obj;\n    }\n    /**\n     * 使一个对象转化成可观测对象\n     * @param { Object } obj 对象\n     * @param { String } key 对象的key\n     * @param { Any } val 对象的某个key的值\n     */\n    function defineReactive (obj,key,val) {\n        Object.defineProperty(obj, key, {\n            get(){\n                console.log(`${key}属性被读取了`);\n                return val;\n            },\n            set(newVal){\n                console.log(`${key}属性被修改了`);\n                val = newVal;\n            }\n        })\n    }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br")])]),e("p",[s._v("现在，我们就可以这样定义"),e("code",[s._v("car")]),s._v(":")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("let car = observable({\n        'brand':'BMW',\n        'price':3000\n    })\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[e("code",[s._v("car")]),s._v("的两个属性都变得可观测了。")]),s._v(" "),e("h2",{attrs:{id:"依赖收集"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#依赖收集"}},[s._v("#")]),s._v(" 依赖收集")]),s._v(" "),e("p",[s._v("完成了数据的'可观测'，即我们知道了数据在什么时候被读或写了，那么，我们就可以在数据被读或写的时候通知那些依赖该数据的视图更新了，为了方便，我们需要先将所有依赖收集起来，一旦数据发生变化，就统一通知更新。其实，这就是典型的“发布订阅者”模式，数据变化为“发布者”，依赖对象为“订阅者”。")]),s._v(" "),e("p",[s._v("现在，我们需要创建一个依赖收集容器，也就是消息订阅器Dep，用来容纳所有的“订阅者”。订阅器Dep主要负责收集订阅者，然后当数据变化的时候后执行对应订阅者的更新函数。")]),s._v(" "),e("p",[s._v("创建消息订阅器Dep:")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    class Dep {\n        constructor(){\n            this.subs = []\n        },\n        //增加订阅者\n        addSub(sub){\n            this.subs.push(sub);\n        },\n        //判断是否增加订阅者\n        depend () {\n            if (Dep.target) {\n                this.addSub(Dep.target)\n            }\n        },\n\n        //通知订阅者更新\n        notify(){\n            this.subs.forEach((sub) =>{\n                sub.update()\n            })\n        }\n    }\nDep.target = null;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br")])]),e("p",[s._v("有了订阅器，再将"),e("code",[s._v("defineReactive")]),s._v("函数进行改造一下，向其植入订阅器：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("function defineReactive (obj,key,val) {\n        let dep = new Dep();\n        Object.defineProperty(obj, key, {\n            get(){\n                dep.depend();\n                console.log(`${key}属性被读取了`);\n                return val;\n            },\n            set(newVal){\n                val = newVal;\n                console.log(`${key}属性被修改了`);\n                dep.notify()                    //数据变化通知所有订阅者\n            }\n        })\n    }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("p",[s._v("从代码上看，我们设计了一个订阅器Dep类，该类里面定义了一些属性和方法，这里需要特别注意的是它有一个静态属性 "),e("code",[s._v("target")]),s._v("，这是一个全局唯一 的"),e("code",[s._v("Watcher")]),s._v("，这是一个非常巧妙的设计，因为在同一时间只能有一个全局的 "),e("code",[s._v("Watcher")]),s._v(" 被计算，另外它的自身属性 "),e("code",[s._v("subs")]),s._v(" 也是 "),e("code",[s._v("Watcher")]),s._v(" 的数组。")]),s._v(" "),e("p",[s._v("我们将订阅器Dep添加订阅者的操作设计在"),e("code",[s._v("getter")]),s._v("里面，这是为了让"),e("code",[s._v("Watcher")]),s._v("初始化时进行触发，因此需要判断是否要添加订阅者。在"),e("code",[s._v("setter")]),s._v("函数里面，如果数据变化，就会去通知所有订阅者，订阅者们就会去执行对应的更新的函数。")]),s._v(" "),e("p",[s._v("到此，订阅器Dep设计完毕，接下来，我们设计订阅者Watcher.")]),s._v(" "),e("h2",{attrs:{id:"订阅者watcher"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#订阅者watcher"}},[s._v("#")]),s._v(" 订阅者Watcher")]),s._v(" "),e("p",[s._v("订阅者"),e("code",[s._v("Watcher")]),s._v("在初始化的时候需要将自己添加进订阅器"),e("code",[s._v("Dep")]),s._v("中，那该如何添加呢？我们已经知道监听器"),e("code",[s._v("Observer")]),s._v("是在"),e("code",[s._v("get")]),s._v("函数执行了添加订阅者"),e("code",[s._v("Wather")]),s._v("的操作的，所以我们只要在订阅者"),e("code",[s._v("Watcher")]),s._v("初始化的时候出发对应的"),e("code",[s._v("get")]),s._v("函数去执行添加订阅者操作即可，那要如何触发"),e("code",[s._v("get")]),s._v("的函数，再简单不过了，只要获取对应的属性值就可以触发了，核心原因就是因为我们使用了"),e("code",[s._v("Object.defineProperty( )")]),s._v("进行数据监听。这里还有一个细节点需要处理，我们只要在订阅者"),e("code",[s._v("Watcher")]),s._v("初始化的时候才需要添加订阅者，所以需要做一个判断操作，因此可以在订阅器上做一下手脚：在"),e("code",[s._v("Dep.target")]),s._v("上缓存下订阅者，添加成功后再将其去掉就可以了。订阅者"),e("code",[s._v("Watcher")]),s._v("的实现如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    class Watcher {\n        constructor(vm,exp,cb){\n            this.vm = vm;\n            this.exp = exp;\n            this.cb = cb;\n            this.value = this.get();  // 将自己添加到订阅器的操作\n        },\n\n        update(){\n            let value = this.vm.data[this.exp];\n            let oldVal = this.value;\n            if (value !== oldVal) {\n                this.value = value;\n                this.cb.call(this.vm, value, oldVal);\n            },\n        get(){\n            Dep.target = this;  // 缓存自己\n            let value = this.vm.data[this.exp]  // 强制执行监听器里的get函数\n            Dep.target = null;  // 释放自己\n            return value;\n        }\n    }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br")])]),e("p",[e("strong",[s._v("过程分析：")])]),s._v(" "),e("p",[s._v("订阅者"),e("code",[s._v("Watcher")]),s._v(" 是一个 类，在它的构造函数中，定义了一些属性：")]),s._v(" "),e("ul",[e("li",[s._v("**vm:**一个Vue的实例对象；")]),s._v(" "),e("li",[s._v("**exp:**是"),e("code",[s._v("node")]),s._v("节点的"),e("code",[s._v("v-model")]),s._v("或"),e("code",[s._v("v-on：click")]),s._v("等指令的属性值。如"),e("code",[s._v('v-model="name"')]),s._v("，"),e("code",[s._v("exp")]),s._v("就是"),e("code",[s._v("name")]),s._v(";")]),s._v(" "),e("li",[s._v("**cb:**是"),e("code",[s._v("Watcher")]),s._v("绑定的更新函数;")])]),s._v(" "),e("p",[s._v("当我们去实例化一个渲染 "),e("code",[s._v("watcher")]),s._v(" 的时候，首先进入 "),e("code",[s._v("watcher")]),s._v(" 的构造函数逻辑，就会执行它的 "),e("code",[s._v("this.get()")]),s._v(" 方法，进入 "),e("code",[s._v("get")]),s._v(" 函数，首先会执行：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("Dep.target = this;  // 缓存自己\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("实际上就是把 "),e("code",[s._v("Dep.target")]),s._v(" 赋值为当前的渲染 "),e("code",[s._v("watcher")]),s._v(" ,接着又执行了：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("let value = this.vm.data[this.exp]  // 强制执行监听器里的get函数\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("在这个过程中会对 "),e("code",[s._v("vm")]),s._v(" 上的数据访问，其实就是为了触发数据对象的"),e("code",[s._v("getter")]),s._v("。")]),s._v(" "),e("p",[s._v("每个对象值的 "),e("code",[s._v("getter")]),s._v("都持有一个 "),e("code",[s._v("dep")]),s._v("，在触发 "),e("code",[s._v("getter")]),s._v(" 的时候会调用 "),e("code",[s._v("dep.depend()")]),s._v(" 方法，也就会执行"),e("code",[s._v("this.addSub(Dep.target)")]),s._v(",即把当前的 "),e("code",[s._v("watcher")]),s._v(" 订阅到这个数据持有的 "),e("code",[s._v("dep")]),s._v(" 的 "),e("code",[s._v("subs")]),s._v(" 中，这个目的是为后续数据变化时候能通知到哪些 "),e("code",[s._v("subs")]),s._v(" 做准备。")]),s._v(" "),e("p",[s._v("这样实际上已经完成了一个依赖收集的过程。那么到这里就结束了吗？其实并没有，完成依赖收集后，还需要把 "),e("code",[s._v("Dep.target")]),s._v(" 恢复成上一个状态，即：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("Dep.target = null;  // 释放自己\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("因为当前"),e("code",[s._v("vm")]),s._v("的数据依赖收集已经完成，那么对应的渲染"),e("code",[s._v("Dep.target")]),s._v(" 也需要改变。")]),s._v(" "),e("p",[s._v("而"),e("code",[s._v("update()")]),s._v("函数是用来当数据发生变化时调用"),e("code",[s._v("Watcher")]),s._v("自身的更新函数进行更新的操作。先通过"),e("code",[s._v("let value = this.vm.data[this.exp];")]),s._v("获取到最新的数据,然后将其与之前"),e("code",[s._v("get()")]),s._v("获得的旧数据进行比较，如果不一样，则调用更新函数"),e("code",[s._v("cb")]),s._v("进行更新。")]),s._v(" "),e("p",[s._v("至此，简单的订阅者"),e("code",[s._v("Watcher")]),s._v("设计完毕。")]),s._v(" "),e("h2",{attrs:{id:"测试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[s._v("#")]),s._v(" 测试")]),s._v(" "),e("p",[s._v("完成以上工作后，我们就可以来真正的测试了。")]),s._v(" "),e("p",[s._v("index.html")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <title>Document</title>\n</head>\n<body>\n    <h1 id="name"></h1>\n    <input type="text">\n    <input type="button" value="改变data内容" onclick="changeInput()">\n    \n<script src="observer.js"><\/script>\n<script src="watcher.js"><\/script>\n<script>\n    function myVue (data, el, exp) {\n        this.data = data;\n        observable(data);                      //将数据变的可观测\n        el.innerHTML = this.data[exp];           // 初始化模板数据的值\n        new Watcher(this, exp, function (value) {\n            el.innerHTML = value;\n        });\n        return this;\n    }\n\n    var ele = document.querySelector(\'#name\');\n    var input = document.querySelector(\'input\');\n    \n    var myVue = new myVue({\n        name: \'hello world\'\n    }, ele, \'name\');\n    \n    //改变输入框内容\n    input.oninput = function (e) {\n        myVue.data.name = e.target.value\n    }\n    //改变data内容\n    function changeInput(){\n        myVue.data.name = "难凉热血"\n    \n    }\n<\/script>\n</body>\n</html>\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br")])]),e("p",[s._v("observer.js")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    /**\n     * 把一个对象的每一项都转化成可观测对象\n     * @param { Object } obj 对象\n     */\n    function observable (obj) {\n        if (!obj || typeof obj !== 'object') {\n            return;\n        }\n        let keys = Object.keys(obj);\n        keys.forEach((key) =>{\n            defineReactive(obj,key,obj[key])\n        })\n        return obj;\n    }\n    /**\n     * 使一个对象转化成可观测对象\n     * @param { Object } obj 对象\n     * @param { String } key 对象的key\n     * @param { Any } val 对象的某个key的值\n     */\n    function defineReactive (obj,key,val) {\n        let dep = new Dep();\n        Object.defineProperty(obj, key, {\n            get(){\n                dep.depend();\n                console.log(`${key}属性被读取了`);\n                return val;\n            },\n            set(newVal){\n                val = newVal;\n                console.log(`${key}属性被修改了`);\n                dep.notify()                    //数据变化通知所有订阅者\n            }\n        })\n    }\n    class Dep {\n        \n        constructor(){\n            this.subs = []\n        }\n        //增加订阅者\n        addSub(sub){\n            this.subs.push(sub);\n        }\n        //判断是否增加订阅者\n        depend () {\n            if (Dep.target) {\n                this.addSub(Dep.target)\n            }\n        }\n\n        //通知订阅者更新\n        notify(){\n            this.subs.forEach((sub) =>{\n                sub.update()\n            })\n        }\n        \n    }\n    Dep.target = null;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br")])]),e("p",[s._v("watcher.js")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    class Watcher {\n        constructor(vm,exp,cb){\n            this.vm = vm;\n            this.exp = exp;\n            this.cb = cb;\n            this.value = this.get();  // 将自己添加到订阅器的操作\n        }\n        get(){\n            Dep.target = this;  // 缓存自己\n            let value = this.vm.data[this.exp]  // 强制执行监听器里的get函数\n            Dep.target = null;  // 释放自己\n            return value;\n        }\n        update(){\n            let value = this.vm.data[this.exp];\n            let oldVal = this.value;\n            if (value !== oldVal) {\n                this.value = value;\n                this.cb.call(this.vm, value, oldVal);\n            }\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br")])]),e("p",[s._v("效果：\n"),e("img",{attrs:{src:"https://img2018.cnblogs.com/blog/1460995/201811/1460995-20181104133334539-861459363.gif",alt:"img"}})]),s._v(" "),e("p",[s._v("完整代码，请戳这里☞ "),e("a",{attrs:{href:"https://github.com/NLRX-WJC/binding-of-Vue-data",target:"_blank",rel:"noopener noreferrer"}},[s._v("vue数据双向绑定原理及实现"),e("OutboundLink")],1)]),s._v(" "),e("h2",{attrs:{id:"总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),e("p",[s._v("总结一下：")]),s._v(" "),e("p",[s._v("实现数据的双向绑定，首先要对数据进行劫持监听，所以我们需要设置一个监听器"),e("code",[s._v("Observer")]),s._v("，用来监听所有属性。如果属性发上变化了，就需要告诉订阅者"),e("code",[s._v("Watcher")]),s._v("看是否需要更新。因为订阅者是有很多个，所以我们需要有一个消息订阅器"),e("code",[s._v("Dep")]),s._v("来专门收集这些订阅者，然后在监听器"),e("code",[s._v("Observer")]),s._v("和订阅者"),e("code",[s._v("Watcher")]),s._v("之间进行统一管理的。\n"),e("img",{attrs:{src:"https://img2018.cnblogs.com/blog/1460995/201810/1460995-20181031180946605-2096088830.png",alt:"img"}})]),s._v(" "),e("h2",{attrs:{id:"参考链接"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考链接"}},[s._v("#")]),s._v(" 参考链接")]),s._v(" "),e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/wangjiachen666/p/9883916.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("原文通俗易懂了解Vue双向绑定原理及实现"),e("OutboundLink")],1)]),s._v(" "),e("p",[e("a",{attrs:{href:"https://segmentfault.com/a/1190000019700618",target:"_blank",rel:"noopener noreferrer"}},[s._v("深入浅出Vue响应式原理"),e("OutboundLink")],1)])])}),[],!1,null,null,null);n.default=t.exports}}]);